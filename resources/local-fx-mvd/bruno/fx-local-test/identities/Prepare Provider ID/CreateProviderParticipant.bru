meta {
  name: CreateProviderParticipant
  type: http
  seq: 1
}

post {
  url: {{PROVIDER_IDHUB_ID_API}}/v1alpha/participants
  body: json
  auth: inherit
}

headers {
  x-api-key: YWRtaW4.adminKey
}

body:json {
  {
      "roles":[],
      "serviceEndpoints":[{
        "id": "ConsumerCredentialService-ID",
        "type": "CredentialService", 
        "serviceEndpoint": "http://provider-idhub:13131/api/credentials/v1/participants/ZGlkOndlYjpwcm92aWRlci1pZGh1Yjp1c2VyOnByb3ZpZGVy"
      }],
      "active": true,
      "participantId": "did:web:provider-idhub:user:provider",
      "did": "did:web:provider-idhub:user:provider",
      "key":{
          "keyId": "did:web:provider-idhub:user:provider#key-1",
          "privateKeyAlias": "did:web:provider-idhub:user:provider-alias",
          "keyGeneratorParams":{
              "algorithm": "EdDSA",
              "curve": "Ed25519"
          }
      }
  }
}

script:post-response {
  const apiKey = res.getBody().apiKey.trim();
  if (apiKey) {
    bru.setEnvVar("PROVIDER_IH_APIKEY", apiKey);
  }
  const stsSecret = res.getBody().clientSecret.trim();
  if (stsSecret) {
    bru.setEnvVar("PROVIDER_STS_SECRET", stsSecret)
  }
}

settings {
  encodeUrl: true
  timeout: 0
}
